name: ğŸ§ª Test Deployment

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version
      
      - name: ğŸ” Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" | sf org login sfdx-url --stdin --alias TestOrg --set-default
          sf org display --target-org TestOrg
      
      - name: ğŸ“‹ List Existing Metadata
        run: |
          echo "ğŸ“‹ Checking what's in the project:"
          ls -la force-app/main/default/
          echo ""
          echo "ğŸ” Apex Classes:"
          ls -la force-app/main/default/classes/ || echo "No classes found"
          echo ""
          echo "ğŸ“¦ Objects:"
          ls -la force-app/main/default/objects/ || echo "No objects found"
      
      - name: ğŸš€ Deploy to Salesforce
        run: |
          echo "ğŸš€ Deploying PropertyTriggerHandler and Test classes..."
          sf project deploy start --source-dir force-app --target-org TestOrg --test-level NoTestRun --wait 15 --verbose
      
      - name: âœ… Verify Deployment
        run: |
          echo "âœ… Deployment completed!"
          echo "ğŸ” Checking deployed components..."
          sf org list metadata --target-org TestOrg --metadata-type ApexClass
          echo ""
          echo "ğŸ‰ SUCCESS! Your CI/CD pipeline is working!"
          echo "ğŸ“± Check your Salesforce org: https://cloudseek-dev-ed.develop.lightning.force.com" 